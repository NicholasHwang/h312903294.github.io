---
layout: post
title: 一致性Hash
date: 2019-07-22
author: Nicholas Huang
header-img:
categories: DistributedSystem
tags:
    - DistributedSystem
---
# 一致性Hash
## 为什么需要一致性Hash
很多博客都从实际的应用场景来逐步说明为什么需要这么一个算法，我想从GFS的论文来说明。
大家都知道，GFS是一个Master管理多个Chunk，每个文件都在一个固定的Chunk的某几个连续块中——稍微展开说下，此处的文件的概念和Linux的FS中的文件类似，即万物皆文件。那么既然是多个Chunk，怎么来觉得文件放到哪个Chunk中，后续的读有能准确快速的找到这个Chunk呢？这个是不是很类似Map，key是通过某个算法得到的一个固定值，value就是需要的信息。既然类似Map，那么就用Hash来处理啊。想法不错，不过有个问题，**如果Chunk在增减，Hash取Chunk长度模是一个变量啊**，这是弄啥呢！

但是，Hash能做到O(1)，再不济O(logn)啊，实在太诱人了啊。

上面的问题其实在于用可变的Chunck长度取模是一个变量，那找一个不变量来取模，不就解决了么。
根据Hash的特性，我们知道，不变量越大，均匀性越好。
那么计算机能表示的常量的最大值是多少？int是2^32，long是2^64。

[简单介绍](https://zhuanlan.zhihu.com/p/34985026)，一致性Hash就是解决一个均匀分配位置的问题
两个特点：
    
    1.均匀
    2.分配位置

## 怎样做到均匀
    
    1.虚拟节点，是实际节点（机器）在Hash空间的复制品，一个实际节点对应了若干个虚拟节点
    2.确保每个节点负责环上同等大小的一部分
    3.每个实际机器上的多个节点需要存在于环上的多个地方且相互交叉，这样可以从统计学的角度保证负载被均匀分布
    
    
## 怎样做到分配位置
    
    1.对环形空间（通常是0~2^32-1）取模，避免了对机器数量取模导致的可变性
    2.如果某台机器/某个节点挂掉，顺时针寻找下一台机器/下一个节点，为了将O(n)的查找时间降低，可以使环形空间有序，这样使用二分查找可以降低到O(logn)
    2.机器到环形空间的映射在整个集群上是共享的
    
## 相关算法介绍
[一致性哈希](https://blog.laisky.com/p/consistent-hashing/#wBWSwgHkjUSpwsJ)


